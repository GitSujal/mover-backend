;; PgBouncer configuration for production connection pooling
;; External connection pooler for PostgreSQL
;;
;; Benefits:
;; - Reduces database connections (thousands of clients -> ~100 DB connections)
;; - Connection pooling at infrastructure level
;; - Transparent to application
;; - Lower memory usage on database server
;;
;; Usage:
;; 1. Deploy PgBouncer as sidecar or separate service
;; 2. Point DATABASE_URL to PgBouncer instead of PostgreSQL directly
;; 3. PgBouncer manages connections to PostgreSQL

[databases]
movehub = host=postgres-master.internal port=5432 dbname=movehub

[pgbouncer]
;; Connection Pooling Mode
;; - session: Connection held for entire client session (safest, required for RLS)
;; - transaction: Connection held only during transaction (best performance)
;; - statement: Connection held only during statement execution (most aggressive)
pool_mode = session

;; Connection Limits
;; Total connections PgBouncer will make to PostgreSQL
max_db_connections = 100

;; Per-database connection limits
default_pool_size = 25
reserve_pool_size = 10
reserve_pool_timeout = 3

;; Client Connection Limits
;; Total clients that can connect to PgBouncer
max_client_conn = 1000

;; Per-user limits
max_user_connections = 100

;; Timeouts
;; Close server connection if idle for N seconds
server_idle_timeout = 600

;; Close client connection if idle for N seconds
client_idle_timeout = 0

;; How long to wait for server connection
server_connect_timeout = 15

;; How long to wait for server during login
server_login_retry = 15

;; If client has been waiting this long, use reserve pool
query_wait_timeout = 120

;; Logging
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; Admin
admin_users = pgbouncer_admin
stats_users = stats

;; Authentication
;; For production, use md5 or scram-sha-256
auth_type = scram-sha-256
auth_file = /etc/pgbouncer/userlist.txt

;; Listening
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix Socket
unix_socket_dir = /var/run/pgbouncer

;; TLS/SSL (for production)
;client_tls_sslmode = require
;client_tls_ca_file = /etc/ssl/certs/ca.pem
;client_tls_cert_file = /etc/ssl/certs/server.crt
;client_tls_key_file = /etc/ssl/private/server.key

;server_tls_sslmode = require
;server_tls_ca_file = /etc/ssl/certs/ca.pem

;; Performance Tuning
;; Disable Nagle algorithm for better latency
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 60
tcp_keepintvl = 10

;; Connection Sanity Checks
server_check_delay = 30
server_check_query = SELECT 1

;; Application Name Tracking
application_name_add_host = 1

;; Verbose Logging (disable in production)
;verbose = 1

[users]
;; User credentials (in production, use auth_file instead)
;; Format: "username" "password"
